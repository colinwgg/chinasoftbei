<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>AI é¢è¯•ä¸­</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
  <div class="container py-5">
    <h2 class="mb-4">å²—ä½ï¼š{{ job_title }}</h2>
    <div class="card shadow-sm">
      <div class="card-body">
        <h5 class="card-title">é¢è¯•é—®é¢˜</h5>
        <p id="question" class="card-text">è¯·ç‚¹å‡»æŒ‰é’®å¼€å§‹å½•éŸ³ã€‚</p>

        <button id="startBtn" class="btn btn-success">ğŸ¤ å¼€å§‹å½•éŸ³</button>
        <button id="stopBtn" class="btn btn-danger" disabled>â¹ï¸ åœæ­¢å¹¶ä¸Šä¼ </button>
        <p class="mt-3" id="status">çŠ¶æ€ï¼šç­‰å¾…å¼€å§‹</p>
      </div>
    </div>

    <div class="mt-5">
      <button id="nextBtn" class="btn btn-primary" disabled>ä¸‹ä¸€é¢˜</button>
    </div>
  </div>

<script>
let mediaRecorder;
let audioChunks = [];
let currentQuestionIndex = 0;
const questions = [
  "è¯·ç®€è¦ä»‹ç»ä¸€ä¸‹ä½ è‡ªå·±ã€‚",
  "ä½ ä¸ºä»€ä¹ˆé€‰æ‹©ç”³è¯·è¿™ä¸ªå²—ä½ï¼Ÿ",
  "ä½ é‡åˆ°è¿‡æœ€å¤§çš„æŒ‘æˆ˜æ˜¯ä»€ä¹ˆï¼Ÿ",
  "ä½ å¦‚ä½•å¤„ç†ä¸åŒäº‹çš„åˆ†æ­§ï¼Ÿ",
  "æœªæ¥äº”å¹´ä½ çš„èŒä¸šè§„åˆ’æ˜¯ï¼Ÿ"
];

const questionEl = document.getElementById("question");
const statusEl = document.getElementById("status");
const startBtn = document.getElementById("startBtn");
const stopBtn = document.getElementById("stopBtn");
const nextBtn = document.getElementById("nextBtn");

function loadQuestion() {
  if (currentQuestionIndex < questions.length) {
    questionEl.textContent = questions[currentQuestionIndex];
  } else {
    window.location.href = '/result';
  }
}

startBtn.onclick = async () => {
  const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
  mediaRecorder = new MediaRecorder(stream);
  audioChunks = [];

  mediaRecorder.ondataavailable = e => audioChunks.push(e.data);

  mediaRecorder.onstop = async () => {
    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
    const formData = new FormData();
    formData.append('audio', audioBlob, 'answer.webm');
    formData.append('question', questions[currentQuestionIndex]);

    statusEl.textContent = "ä¸Šä¼ ä¸­...";
    const res = await fetch('/api/process_answer', {
      method: 'POST',
      body: formData
    });
    const data = await res.json();
    if (data.status === 'success') {
      statusEl.textContent = "ä¸Šä¼ æˆåŠŸï¼ŒAI å·²å®Œæˆåˆ†æã€‚";
      nextBtn.disabled = false;
    } else {
      statusEl.textContent = "å‡ºé”™å•¦: " + data.message;
    }
  };

  mediaRecorder.start();
  statusEl.textContent = "å½•éŸ³ä¸­...";
  startBtn.disabled = true;
  stopBtn.disabled = false;
};

stopBtn.onclick = () => {
  mediaRecorder.stop();
  statusEl.textContent = "å½•éŸ³åœæ­¢ï¼Œå‡†å¤‡ä¸Šä¼ ...";
  stopBtn.disabled = true;
};

nextBtn.onclick = () => {
  currentQuestionIndex++;
  nextBtn.disabled = true;
  startBtn.disabled = false;
  loadQuestion();
};

loadQuestion();
</script>
</body>
</html>